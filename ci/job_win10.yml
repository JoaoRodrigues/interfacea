 parameters:
  OS: ''
  image: ''

 stages:
  - stage: "Builder_${{ parameters.OS }}"  # stage names must be unique
    dependsOn: []

    jobs:
      - template: job_backbone.yml
        parameters:
          displayName: ${{ parameters.OS }}
          vmImage: ${{ parameters.image }}
          steps:
            - script: |
                call activate $(condaEnvName)
                python setup.py build
                python setup.py install
                python -c "import interfacea as ia; print(ia.__version__)"
              displayName: Build & Install

  # These two will run in parallel since they share the same dependency
  # Only run if the Builder step is successful
  - stage: "Linter_${{ parameters.OS }}"
    dependsOn: "Builder_${{ parameters.OS }}"
    condition: succeeded('Builder_${{ parameters.OS }}')

    jobs:
      - template: job_backbone.yml
        parameters:
          displayName: ${{ parameters.OS }}
          vmImage: ${{ parameters.image }}
          steps:
            - script: |
                call activate $(condaEnvName)
                flake8 .
              displayName: Run Flake8

  - stage: "Tester_${{ parameters.OS }}"
    dependsOn: "Builder_${{ parameters.OS }}"
    condition: succeeded('Builder_${{ parameters.OS }}')

    jobs:
      - template: job_backbone.yml
        parameters:
          displayName: ${{ parameters.OS }}
          vmImage: ${{ parameters.image }}
          steps:
            - script: |
                call activate $(condaEnvName)
                pip install -e .
                pip install pytest-azurepipelines
                pytest . --cov=interfacea --cov-report=xml --cov-report=html
              displayName: Run Unit Tests
