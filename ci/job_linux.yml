 parameters:
  OS: ''
  image: ''

 stages:
  - stage: "Builder_${{ parameters.OS }}"  # stage names must be unique
    dependsOn: []

    jobs:
      - template: job_backbone.yml
        parameters:
          displayName: ${{ parameters.OS }}
          vmImage: ${{ parameters.image }}
          steps:
            - script: |
                source activate $(condaEnvName)
                python setup.py build
                python setup.py install
                python -c "import interfacea as ia; print(ia.__version__)"
              displayName: Build & Install

  # These two will run in parallel since they share the same dependency
  # Only run if the Builder step is successful
  - stage: "Linter_${{ parameters.OS }}"
    dependsOn: "Builder_${{ parameters.OS }}"
    condition: succeeded('Builder_${{ parameters.OS }}')

    jobs:
      - template: job_backbone.yml
        parameters:
          displayName: ${{ parameters.OS }}
          vmImage: ${{ parameters.image }}
          steps:
            - script: |
                source activate $(condaEnvName)
                flake8 .
              displayName: Run Flake8

  - stage: "Tester_${{ parameters.OS }}"
    dependsOn: "Builder_${{ parameters.OS }}"
    condition: succeeded('Builder_${{ parameters.OS }}')

    jobs:
      - template: job_backbone.yml
        parameters:
          displayName: ${{ parameters.OS }}
          vmImage: ${{ parameters.image }}
          steps:
            - script: |
                source activate $(condaEnvName)
                curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
                chmod +x ./cc-test-reporter
                ./cc-test-reporter before-build
              env:
                GIT_BRANCH: $(Build.SourceBranchName)
                GIT_COMMIT: $(Build.SourceVersion)
              displayName: Setup Test Coverage Report
            - script: |
                source activate $(condaEnvName)
                pip install -e .
                pip install pytest-azurepipelines
                pytest . --cov=interfacea --cov-report=xml
              displayName: Run Tests
              env:
                GIT_BRANCH: $(Build.SourceBranchName)
                GIT_COMMIT: $(Build.SourceVersion)
            - script: |
                source activate $(condaEnvName)
                ./cc-test-reporter format-coverage -t coverage.py -o coverage/codeclimate.json coverage.xml
                ./cc-test-reporter upload-coverage
              displayName: Run Unit Tests
              env:
                GIT_BRANCH: $(Build.SourceBranchName)
                GIT_COMMIT: $(Build.SourceVersion)
