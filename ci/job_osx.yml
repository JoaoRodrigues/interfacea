 variables:
  OS: 'OSX'
  image: 'macOS-10.13'

 stages:
  - stage: Builder
    dependsOn: []

    jobs:
      - template: job_backbone.yml
        parameters:
          displayName: $(OS)
          vmImage: $(image)
          steps:
            - script: |
                source activate $(condaEnvName)
                python setup.py build
                python setup.py install
                python -c 'import interfacea as ia; print(ia.__version__)'
              displayName: Build & Install

  # These two will run in parallel since they share the same dependency
  # Only run if the Builder step is successful
  - stage: Linter
    dependsOn: Builder
    condition: succeeded('Builder')

    jobs:
      - template: job_backbone.yml
        parameters:
          displayName: $(OS)
          vmImage: $(image)
          steps:
            - script: |
                source activate $(condaEnvName)
                flake8 .
              displayName: Run Flake8

  - stage: Tester
    dependsOn: Builder
    condition: succeeded('Builder')

    jobs:
      - template: job_backbone.yml
        parameters:
          displayName: $(OS)
          vmImage: $(image)
          steps:
            - script: |
                source activate $(condaEnvName)
                python setup.py test  # soon to be deprecated, move to pytest
              displayName: Run Unit Tests
